{% extends "base.html" %}
{% block content %}
<h3>Подождите, архив собирается…</h3>

<progress id="buildProgress" value="0" max="100" style="width:100%;"></progress>

<script>
    (() => {
        const progressUrlName = "wait-progress";
        const progressUrl = "{% url 'wait-progress' archive.short_code %}";
        const downloadUrl = "{% url 'download' archive.short_code %}";
        const progressEl = document.getElementById("buildProgress");

        const poll = () => {
            fetch(progressUrl)
                .then(r => r.json())
                .then(data => {
                    progressEl.value = data.pct;
                    if (data.pct < 100) {
                        setTimeout(poll, 1000);
                    } else {
                        window.location = downloadUrl;
                    }
                })
                .catch(() => setTimeout(poll, 1000));
        };
        poll();
    })();
</script>
{% endblock %}