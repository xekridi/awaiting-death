{% extends "base.html" %}
{% block content %}
<h3>Загрузить архив</h3>

<form id="uploadForm" action="{% url 'upload' %}" method="post" enctype="multipart/form-data" class="vstack gap-3">
    {% csrf_token %}
    {{ form.non_field_errors }}

    <div>
        {{ form.description.label_tag }}
        {{ form.description }}
        {{ form.description.errors }}
    </div>

    <div>
        {{ form.files.label_tag }}
        {{ form.files }}
        {{ form.files.errors }}
        <small>Удерживайте Ctrl/⌘, чтобы выбрать несколько</small>
    </div>

    <div>
        {{ form.password1.label_tag }} {{ form.password1 }}
        {{ form.password2.label_tag }} {{ form.password2 }}
        {{ form.password2.errors }}
    </div>

    <div>
        {{ form.max_downloads.label_tag }} {{ form.max_downloads }}
        {{ form.max_downloads.errors }}
    </div>

    <div>
        {{ form.expires_at.label_tag }} {{ form.expires_at }}
        {{ form.expires_at.errors }}
    </div>

    <button class="btn btn-primary" type="submit">Собрать ZIP</button>
</form>

<progress id="uploadProgress" value="0" max="100" style="display:none;width:100%;margin-top:1rem;"></progress>

<script>
    (() => {
        const form = document.getElementById("uploadForm");
        const bar = document.getElementById("uploadProgress");

        form.addEventListener("submit", async e => {
            e.preventDefault();
            bar.style.display = "block";
            bar.value = 0;

            const data = new FormData(form);
            const resp = await fetch(form.action, {
                method: 'POST',
                body: data,
                redirect: 'manual'
            });

            const loc = resp.headers.get('Location');
            if (loc) {
                window.location = loc;
                return;
            }

            alert("Ошибка загрузки: " + resp.status);
        });
    })();
</script>
{% endblock %}