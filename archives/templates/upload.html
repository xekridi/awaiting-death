{% extends "base.html" %}
{% block content %}
<h3>Загрузить архив</h3>
<form id="uploadForm" method="post" action="{% url 'upload' %}" enctype="multipart/form-data">
    {% csrf_token %}
    {{ form.non_field_errors }}
    <div>{{ form.description.label_tag }} {{ form.description }} {{ form.description.errors }}</div>
    <div>{{ form.files.label_tag }} {{ form.files }} {{ form.files.errors }}</div>
    <div>
        {{ form.password1.label_tag }} {{ form.password1 }}
        {{ form.password2.label_tag }} {{ form.password2 }} {{ form.password2.errors }}
    </div>
    <div>{{ form.max_downloads.label_tag }} {{ form.max_downloads }} {{ form.max_downloads.errors }}</div>
    <div>{{ form.expires_at.label_tag }} {{ form.expires_at }} {{ form.expires_at.errors }}</div>
    <button class="btn btn-primary" type="submit">Собрать ZIP</button>
</form>
<progress id="uploadProgress" value="0" max="100" style="display:none;width:100%;"></progress>

<script>
    (() => {
        const form = document.getElementById("uploadForm");
        const bar = document.getElementById("uploadProgress");

        form.addEventListener("submit", async e => {
            e.preventDefault();
            bar.style.display = "block";
            bar.value = 0;

            const data = new FormData(form);
            const resp = await fetch(form.action, {
                method: 'POST',
                body: data,
                redirect: 'manual'
            });

            const loc = resp.headers.get('Location');
            if (loc) {
                window.location = loc;
                return;
            }

            if (resp.type === 'opaqueredirect' || resp.status === 302 || resp.status === 303) {
                window.location = form.action.replace('upload', 'wait') + '/';
                return;
            }

            if (resp.ok) {
                const text = await resp.text();
                document.open(); document.write(text); document.close();
                return;
            }

            alert("Ошибка загрузки: " + resp.status);
        });
    })();
</script>
{% endblock %}